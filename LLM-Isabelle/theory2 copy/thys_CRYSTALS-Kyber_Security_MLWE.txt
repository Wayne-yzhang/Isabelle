theory MLWE

imports Lemmas_for_spmf
        "Game_Based_Crypto.CryptHOL_Tutorial"

begin



unbundle %invisible lifting_syntax
no_adhoc_overloading %invisible Monad_Syntax.bind bind_pmf
declare %invisible [[names_short]]



(module-LWE) problem in the setting of Kyber. 
The locale takes as input:
\begin{itemize}
    trick in the Kyber locale.)
   (This is a side effect of the Harrison trick in the Kyber locale.)
\end{itemize}\<close>
text \<open>The adversary in the module-LWE takes a matrix \<open>A::(('b, 'n) vec, 'm) vec\<close> and a vector
  \<open>t::('b, 'm) vec\<close> and returns a probability distribution on \<open>bool\<close> 
\<open>bit_set\<close> returns the set of all bit lists of length \<open>eta\<close>.
\<open>beta\<close> is the centered binomial distribution $\beta_\eta$ as a \<open>pmf\<close> on the quotient ring $R_q$.
\<open>beta_vec\<close> is then centered binomial distribution $\beta_\eta ^k$ on vectors in $R_q^k$.\<close>
text \<open>Since we work over \<open>spmf\<close>, we need to show that \<open>beta_vec\<close> is lossless.\<close>
text \<open>We define the game versions of module-LWE.

definition game :: "('a qr,'k,'k) adversary \<Rightarrow> bool spmf" where
  "game \<A>  = do {
    A \<leftarrow> spmf_of_set (UNIV:: (('a qr, 'k) vec, 'k) vec set);
    s \<leftarrow> beta_vec;
    e \<leftarrow> beta_vec;
    b' \<leftarrow> \<A> A (A *v s + e);
    return_spmf (b')
  }"

definition game_random :: "('a qr,'k,'k) adversary \<Rightarrow> bool spmf" where
  "game_random \<A>  = do {
    A \<leftarrow> spmf_of_set (UNIV:: (('a qr, 'k) vec, 'k) vec set);
    b \<leftarrow> spmf_of_set (UNIV:: ('a qr, 'k) vec set);
    b' \<leftarrow> \<A> A b;
    return_spmf (b')
  }"

whether the instance is generated by the module-LWE or uniformly at random.\<close>
text \<open>Since the reduction proof of Kyber uses the module-LWE problem for two different dimensions
(ie.\ $A\in R_q^{(k+1)\times k}$ and $A\in R_q^{k\times k}$), we need a second definition of
the index function, the centered binomial distribution, the game and random game, and the advantage.
That makes it hard to ``simply add'' another dimension. A trick how this can be formalised 
Note also that the additional index appears only in one dimension of $A$, resulting in 
a non-quadratic matrix.\<close>
text \<open>Index function of the option type \<open>'k option\<close>.\<close>
text \<open>Definition of the centered binomial distribution $\beta_\eta^{k+1}$ and lossless property.\<close>
text \<open>Some lemmas on replicate.\<close>
text \<open>Lemma to split the \<open>replicate (k+1)\<close> function in \<open>beta_vec'\<close> into two parts: 
\<open>replicate k\<close> and a separate value. Note, that the \<open>xs\<close> in the \<open>do\<close> notation below are 
